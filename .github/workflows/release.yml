#
# Template based on origin https://github.com/helm/charts-repo-actions-demo/blob/master/.github/workflows/release.yaml
#
name: Helm Chart Release
on:
  push:
    branches:
      - master

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Fetch history
        run: git fetch --prune --unshallow

      # Install Helm (Dependency)
      - name: Install Helm Binary
        run: |
          curl -fsSLo get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
          chmod 700 get_helm.sh
          ./get_helm.sh

      # Install Chart Releaser (Dependency)
      - name: Chart Releaser Binary
        env:
          CR_VERSION: "1.0.0-beta.1"
        run: |
          curl -sL "https://github.com/helm/chart-releaser/releases/download/v${CR_VERSION}/chart-releaser_${CR_VERSION}_linux_amd64.tar.gz" | tar zx && chmod +x ./cr && sudo mv ./cr /usr/local/bin/

      # Run Release Script
      - name: Release Charts
        env:
          CR_TOKEN: "${{ secrets.CR_TOKEN }}"
          CR_REPO_URL: "https://bedag-charts.github.io/helm-charts"
        run: |
          bash .github/release/release.sh
