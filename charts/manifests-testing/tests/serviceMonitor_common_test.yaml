suite: ServiceMonitor Common Values Test
templates:
  - manifests.yaml
tests:
##
## Passing Test Scenarios
##

  ##
  ##
  - it: Common Labels & Partial Name
    values:
      - ./values/common/name.yaml
      - ./values/common/labels.yaml
      - ./values/manifests/serviceMonitor.yaml
    asserts:
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-partial"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.[app.kubernetes.io/name]
          value: "RELEASE-NAME-partial"
      - equal:
          path: metadata.labels.[test.label/1]
          value: true
      - equal:
          path: metadata.labels.[common.label/1]
          value: true
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 
      - equal:
          path: spec.selector.matchLabels.[app.kubernetes.io/name]
          value: "RELEASE-NAME-partial"
      - equal:
          path: spec.selector.matchLabels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"

  ##
  ##
  - it: Fullname Overwrite
    values:
      - ./values/common/fullname.yaml
      - ./values/manifests/serviceMonitor.yaml
    asserts:
      - equal:
          path: metadata.name
          value: "fullname"
      - equal:
          path: metadata.labels.[app.kubernetes.io/name]
          value: "fullname"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 
      - equal:
          path: spec.selector.matchLabels.[app.kubernetes.io/name]
          value: "fullname"
      - equal:
          path: spec.selector.matchLabels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"

  ##
  ##
  - it: Fullname and Labels Overwrite
    values:
      - ./values/common/fullname.yaml
      - ./values/common/overwrites.yaml
      - ./values/manifests/serviceMonitor.yaml
    asserts:
      - equal:
          path: metadata.name
          value: "fullname"
      - equal:
          path: metadata.labels.[common.overwrite/1]
          value: true
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/instance]
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 
      - isEmpty:
          path: metadata.labels.[common.label/1] 


  ##
  ##
  - it: Common Selector
    values:
      - ./values/common/selector.yaml
      - ./values/manifests/serviceMonitor.yaml
    asserts:
      - equal:
          path: spec.selector.matchLabels.[common.selector/1]
          value: true

  ##
  ##
  - it: Selector has priority over SelectorLabels and Common Selector
    values:
      - ./values/common/selector.yaml
      - ./values/manifests/serviceMonitor.yaml
    set:
      unit:
        manifests: 
          servicemonitor:
            selectorLabels:
              "test.selector/1": true
            selector: 
              matchExpressions:
                - {key: es-node, operator: In, values: [data-1, data-2, data-3]}  
    asserts:
      - contains:
          path: spec.selector.matchExpressions
          content:
            key: es-node
            operator: In
            values:
            - data-1
            - data-2
            - data-3

  ##
  ##
  - it: Label Selector
    values:
      - ./values/common/selector.yaml
      - ./values/manifests/serviceMonitor.yaml
    set:
      unit:
        manifests: 
          servicemonitor:
            selectorLabels:
              "test.selector/1": true
    asserts:
      - equal:
          path: spec.selector.matchLabels.[test.selector/1]
          value: true