suite: Test Service Manifest
templates:
  - manifests.yaml
tests:

##
## Passing Test Scenarios
##

  ##
  ## Set all available Values (Check Defaults)
  - it: Full Configured (Snapshot)
    values:
      - ./values/manifests/service.yaml
    asserts:
      - matchSnapshot: {}

  ##
  ## Service Disabled
  - it: Disable Service
    set:
      unit:
        manifests: 
          service:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  ##
  ## Implicit ClusterIP Service
  - it: implicit ClusterIP Service
    set:
      unit:
        manifests: 
          service:
            portName: "clusterip-svc-port"
            type: ClusterIP
            port: 9999
            targetPort: discovery
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/name]
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: spec.type
          value: "ClusterIP"
      - contains:
          path: spec.ports
          content:
            name: "clusterip-svc-port"
            port: 9999
            nodePort: null
            targetPort: "discovery"
            protocol: "TCP"

  ##
  ## loadBalancerIP Service Test
  - it: Test LoadBalancer Service (loadBalancerIP)
    set:
      unit:
        manifests: 
          service:
            portName: "loadbalancer-svc-port"
            type: LoadBalancer
            loadBalancerIP: 143.231.0.10
            port: 8181
            targetPort: "custom-target"
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/name]
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: spec.type
          value: "LoadBalancer"
      - equal:
          path: spec.loadBalancerIP
          value: "143.231.0.10"
      - contains:
          path: spec.ports
          content:
            name: "loadbalancer-svc-port"
            port: 8181
            targetPort: "custom-target"
            protocol: "TCP"

  ##
  ## LoadBalancerSourceRanges Service Test
  - it: Test LoadBalancer Service (LoadBalancerSourceRanges)
    set:
      unit:
        manifests: 
          service:
            portName: "lb-svc-port"
            type: LoadBalancer
            loadBalancerSourceRanges:
              - "143.231.0.0/16"
              - "143.232.0.0/16"
            port: 8282
            protocol: "ICMP"
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/name]
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: spec.type
          value: "LoadBalancer"
      - equal:
          path: spec.loadBalancerSourceRanges[0]
          value: "143.231.0.0/16"
      - equal:
          path: spec.loadBalancerSourceRanges[1]
          value: "143.232.0.0/16"
      - contains:
          path: spec.ports
          content:
            name: "lb-svc-port"
            port: 8282
            targetPort: "http"
            protocol: "ICMP"

  ##
  ## NodePort Service Test
  - it: Test NodePort Service
    set:
      unit:
        manifests: 
          service:
            type: NodePort
            port: 8080
            nodePort: 30007
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/name]
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: spec.type
          value: "NodePort"
      - contains:
          path: spec.ports
          content:
            name: "http"
            port: 8080
            targetPort: "http"
            protocol: "TCP"
            nodePort: 30007

  ##
  ## Minimal Configuration
  - it: Test Minimal Service Configuration
    set:
      unit:
        manifests: 
          service:
            enabled: true
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/name]
          value: "RELEASE-NAME-manifests-testing"
      - equal:
          path: spec.selector.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: spec.type
          value: "ClusterIP"
      - contains:
          path: spec.ports
          content:
            name: http
            port: 80
            protocol: TCP
            targetPort: http
            nodePort: null