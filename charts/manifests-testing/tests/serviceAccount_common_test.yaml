suite: Test ServiceAccount Common Values
templates:
  - manifests.yaml
tests:
##
## Passing Test Scenarios
##

  ##
  ##
  - it: Common Labels & Partial Name
    values:
      - ./values/common/name.yaml
      - ./values/common/labels.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
            labels:
              "test.label/1": true
    asserts:
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-partial"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.[app.kubernetes.io/name]
          value: "RELEASE-NAME-partial"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.[test.label/1]
          value: true
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 

  ##
  ##
  - it: Local Name has priority over NameOverwrite
    values:
      - ./values/common/name.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
            name: "overwrite"
    asserts:
      - equal:
          path: metadata.name
          value: "overwrite"

  ##
  ##
  - it: Local Name has priority over FullnameOverwrite
    values:
      - ./values/common/fullname.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
            name: "overwrite"
    asserts:
      - equal:
          path: metadata.name
          value: "overwrite"

  ##
  ##
  - it: Fullname Overwrite
    values:
      - ./values/common/fullname.yaml
      - ./values/common/labels.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
    asserts:
      - equal:
          path: metadata.name
          value: "fullname"
      - equal:
          path: metadata.labels.[app.kubernetes.io/name]
          value: "fullname"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 

  ##
  ##
  - it: Fullname and Labels Overwrite
    values:
      - ./values/common/fullname.yaml
      - ./values/common/overwrites.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
    asserts:
      - equal:
          path: metadata.name
          value: "fullname"
      - equal:
          path: metadata.labels.[common.overwrite/1]
          value: true
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/instance]
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 


  ##
  ##
  - it: Merge Global PullSecrets
    values:
      - ./values/common/fullname.yaml
      - ./values/common/overwrites.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
            imagePullSecrets:
              - account-local-secret-1
              - account-local-secret-2
            globalPullSecrets: true
    asserts:
      - equal:
          path: metadata.name
          value: "fullname"
      - equal:
          path: metadata.labels.[common.overwrite/1]
          value: true
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/instance]
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 


      imagePullSecrets: []
      globalPullSecrets: false

