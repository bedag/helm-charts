suite: Test ServiceAccount Manifest
templates:
  - manifests.yaml
tests:


##
## Passing Test Scenarios
##

  - it: Common Labels & Partial Name
    values:
      - ./values/common/name.yaml
      - ./values/common/labels.yaml
    set:
      unit:
        manifests: 
          service:
            enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-partial"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.[app.kubernetes.io/name]
          value: "RELEASE-NAME-partial"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 
      - equal:
          path: spec.selector.[app.kubernetes.io/name]
          value: "RELEASE-NAME-partial"
      - equal:
          path: spec.selector.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"


  - it: Incluenced Common Selector Fields
    values:
      - ./values/common/name.yaml
      - ./values/common/selector.yaml
    set:
      unit:
        manifests: 
          service:
            enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-partial"
      - equal:
          path: spec.selector.[common.selector/1]
          value: true

  ## use COmmon Selector and Manifest Selectors
  - it: Service Selector prioritized over Common Selector
    values:
      - ./values/common/name.yaml
      - ./values/common/labels.yaml
      - ./values/common/selector.yaml
    set:
      unit:
        manifests: 
          service:
            enabled: true
            selector:
              "service.selector/1": true
    asserts:
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-partial"
      - equal:
          path: spec.selector.[service.selector/1]
          value: true
      - isEmpty:
          path: spec.selector.[common.selector/1]

  ## Overwrite Fullname
  - it: Fullname Overwrite
    values:
      - ./values/common/fullname.yaml
      - ./values/common/labels.yaml
    set:
      unit:
        manifests: 
          service:
            enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: "fullname"
      - equal:
          path: metadata.labels.[app.kubernetes.io/name]
          value: "fullname"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 
      - equal:
          path: spec.selector.[app.kubernetes.io/name]
          value: "fullname"
      - equal:
          path: spec.selector.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"

  ## Overwrite Fullname & Labels
  - it: Fullname and Labels Overwrite
    values:
      - ./values/common/fullname.yaml
      - ./values/common/overwrites.yaml
    set:
      unit:
        manifests: 
          service:
            enabled: true
    asserts:
      - equal:
          path: metadata.name
          value: "fullname"
      - equal:
          path: metadata.labels.[common.overwrite/1]
          value: true
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/instance]
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 
      - equal:
          path: spec.selector.[app.kubernetes.io/name]
          value: "fullname"
      - equal:
          path: spec.selector.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"















##
## Passing Test Scenarios
##

  ##
  ## Set all available Values (Check Defaults)
  - it: Full Configured (Snapshot)
    values:
      - ./values/manifests/serviceAccount.yaml
    asserts:
      - matchSnapshot: {}

  ##
  ##
  - it: ServiceAccount Disabled
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: false
    asserts:
      - hasDocuments:
          count: 0

  ##
  ##
  - it: ServiceAccount Disabled but Disabled Creation
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: false
    asserts:
      - hasDocuments:
          count: 0

  ##
  ##
  - it: Custom ServiceAccount Name
    values:
      - ./values/manifests/serviceAccount.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            name: sample
    asserts:
      - equal:
          path: metadata.name
          value: "sample"

