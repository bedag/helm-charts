suite: ServiceAccount Common Values Test
templates:
  - manifests.yaml
tests:
##
## Passing Test Scenarios
##

  ##
  ##
  - it: Common Labels & Partial Name
    values:
      - ./values/common/name.yaml
      - ./values/common/labels.yaml
      - ./values/manifests/serviceAccount.yaml
    asserts:
      - equal:
          path: metadata.name
          value: "RELEASE-NAME-partial"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.[app.kubernetes.io/name]
          value: "RELEASE-NAME-partial"
      - equal:
          path: metadata.labels.[test.label/1]
          value: true
      - equal:
          path: metadata.labels.[common.label/1]
          value: true
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 

  ##
  ##
  - it: Local Name has priority over NameOverwrite
    values:
      - ./values/common/name.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
            name: "overwrite"
    asserts:
      - equal:
          path: metadata.name
          value: "overwrite"

  ##
  ##
  - it: Local Name has priority over FullnameOverwrite
    values:
      - ./values/common/fullname.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
            name: "overwrite"
    asserts:
      - equal:
          path: metadata.name
          value: "overwrite"

  ##
  ##
  - it: Local Name has priority over NameOverwrite and FullnameOverwrite
    values:
      - ./values/common/name.yaml
      - ./values/common/fullname.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
            name: "overwrite"
    asserts:
      - equal:
          path: metadata.name
          value: "overwrite"

  ##
  ##
  - it: Fullname Overwrite
    values:
      - ./values/common/fullname.yaml
      - ./values/common/labels.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
    asserts:
      - equal:
          path: metadata.name
          value: "fullname"
      - equal:
          path: metadata.labels.[app.kubernetes.io/name]
          value: "fullname"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - equal:
          path: metadata.labels.[app.kubernetes.io/instance]
          value: "RELEASE-NAME"
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isNotEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 

  ##
  ##
  - it: Fullname and Labels Overwrite
    values:
      - ./values/common/fullname.yaml
      - ./values/common/overwrites.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
    asserts:
      - equal:
          path: metadata.name
          value: "fullname"
      - equal:
          path: metadata.labels.[common.overwrite/1]
          value: true
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/instance]
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/version] 
      - isEmpty:
          path: metadata.labels.[app.kubernetes.io/managed-by] 
      - isEmpty:
          path: metadata.labels.[common.label/1] 

  ##
  ##
  - it: Merge Global PullSecrets
    values:
      - ./values/common/globals.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
            imagePullSecrets:
              - name: account-local-secret-1
              - name: account-local-secret-2
            globalPullSecrets: true
    asserts:
      - contains:
          path: imagePullSecrets
          content:
            name: private-registry
          any: true
      - contains:
          path: imagePullSecrets
          content:
            name: private-registry-group
          any: true  
      - contains:
          path: imagePullSecrets
          content:
            name: account-local-secret-1
          any: true 
      - contains:
          path: imagePullSecrets
          content:
            name: account-local-secret-2
          any: true 

  ##
  ##
  - it: Disable Merge Global PullSecrets
    values:
      - ./values/common/globals.yaml
    set:
      unit:
        manifests: 
          serviceaccount:
            enabled: true
            create: true
            imagePullSecrets:
              - name: account-local-secret-1
              - name: account-local-secret-2
            globalPullSecrets: false
    asserts:
      - notContains:
          path: imagePullSecrets
          content:
            name: private-registry
          any: true
      - notContains:
          path: imagePullSecrets
          content:
            name: private-registry-group
          any: true  
      - contains:
          path: imagePullSecrets
          content:
            name: account-local-secret-1
          any: true 
      - contains:
          path: imagePullSecrets
          content:
            name: account-local-secret-2
          any: true